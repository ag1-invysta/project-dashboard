<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Project Health Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  --bg:#0b0f1a;--panel:#111827;--panel2:#0f1a2e;--border:#1f2d45;
  --accent:#00d4b4;--accent2:#f97316;--warn:#facc15;--danger:#ef4444;
  --text:#e2e8f0;--muted:#64748b;--green:#22c55e;
  --fh:'Syne',sans-serif;--fm:'DM Mono',monospace;
  --c1:#00d4b4;--c2:#38bdf8;--c3:#818cf8;--c4:#c084fc;--c5:#f472b6;
  --c6:#fb923c;--c7:#facc15;--c8:#a3e635;--c9:#34d399;--c10:#67e8f9;
  --c11:#f43f5e;--c12:#84cc16;--c13:#06b6d4;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--fm);min-height:100vh;}

/* HEADER */
header{padding:22px 36px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,#0b0f1a,#111c2e);position:sticky;top:0;z-index:50;}
.logo{width:36px;height:36px;background:var(--accent);clip-path:polygon(50% 0%,100% 100%,0% 100%);}
header h1{font-family:var(--fh);font-size:1.3rem;font-weight:800;color:#fff;}
header h1 span{color:var(--accent);}
.header-sub{font-size:.68rem;color:var(--muted);margin-top:2px;}
.header-right{margin-left:auto;display:flex;gap:10px;align-items:center;}
.btn{font-family:var(--fm);font-size:.72rem;padding:7px 14px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--panel);color:var(--text);transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{border-color:var(--accent);color:var(--accent);}
.btn-accent{background:rgba(0,212,180,.1);border-color:var(--accent);color:var(--accent);}
.btn-accent:hover{background:rgba(0,212,180,.2);}

/* MAIN */
main{padding:28px 36px;max-width:1700px;margin:0 auto;}
.sec-title{font-family:var(--fh);font-size:.65rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:14px;}

/* CARDS */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin-bottom:32px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.card.warn::before{background:var(--warn);}
.card.danger::before{background:var(--danger);}
.card.good::before{background:var(--green);}
.card:hover{transform:translateY(-2px);border-color:rgba(0,212,180,.4);}
.card.active{border-color:var(--accent);}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;}
.card-name{font-family:var(--fh);font-size:.95rem;font-weight:700;color:#fff;}
.card-id{font-size:.65rem;color:var(--muted);margin-top:2px;}
.badge{font-size:.6rem;padding:2px 8px;border-radius:99px;font-weight:600;letter-spacing:.5px;}
.badge-good{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.25);}
.badge-warn{background:rgba(250,204,21,.12);color:var(--warn);border:1px solid rgba(250,204,21,.25);}
.badge-danger{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.25);}
.scores-row{display:flex;gap:20px;margin-bottom:12px;}
.score-block{flex:1;}
.score-label{font-size:.6rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.score-val{font-family:var(--fh);font-size:2rem;font-weight:800;line-height:1;}
.score-sub{font-size:.85rem;font-weight:400;color:var(--muted);}
.mini-bar{height:3px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden;}
.mini-fill{height:100%;border-radius:2px;transition:width .8s ease;}
.delta-badge{display:inline-flex;align-items:center;gap:3px;font-size:.65rem;padding:2px 6px;border-radius:4px;margin-top:5px;font-weight:600;}
.delta-up{background:rgba(34,197,94,.12);color:var(--green);}
.delta-down{background:rgba(239,68,68,.12);color:var(--danger);}
.delta-flat{background:rgba(100,116,139,.12);color:var(--muted);}
.card-chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.chip{font-size:.63rem;padding:3px 8px;border-radius:5px;background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--muted);}
.chip strong{color:var(--text);}
.chip.warn{border-color:rgba(250,204,21,.3);color:var(--warn);}
.chip.danger{border-color:rgba(239,68,68,.3);color:var(--danger);}

/* NARRATIVE */
.narrative-box{background:rgba(0,212,180,.04);border:1px solid rgba(0,212,180,.15);border-radius:8px;padding:14px 16px;font-size:.75rem;line-height:1.7;color:var(--muted);margin-bottom:32px;}
.narrative-box strong{color:var(--text);}
.narrative-box em{color:var(--accent);}

/* DETAIL */
.detail-panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:32px;display:none;}
.detail-panel.open{display:block;}
.detail-header{display:flex;align-items:center;gap:14px;margin-bottom:24px;flex-wrap:wrap;}
.detail-title{font-family:var(--fh);font-size:1.3rem;font-weight:800;color:#fff;}
.detail-scores{margin-left:auto;display:flex;gap:20px;align-items:center;}
.detail-actions{display:flex;gap:8px;}
.date-row{display:flex;gap:20px;align-items:center;flex-wrap:wrap;margin-top:6px;}
.date-item{display:flex;flex-direction:column;gap:2px;}
.date-item .date-label{font-size:.58rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.date-item .date-val{font-family:var(--fm);font-size:.82rem;font-weight:500;color:var(--text);}
.date-item .date-val.slipped{color:var(--warn);}
.date-item .date-val.on-track{color:var(--green);}
.date-slip-badge{font-size:.65rem;padding:2px 8px;border-radius:5px;font-weight:600;margin-left:6px;}
.slip-pos{background:rgba(250,204,21,.12);color:var(--warn);border:1px solid rgba(250,204,21,.25);}
.slip-none{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25);}
.slip-neg{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25);}
.detail-score-num{font-family:var(--fh);font-size:1.8rem;font-weight:800;}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.chart-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:18px;}
.chart-box h3{font-family:var(--fh);font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.chart-box canvas{max-height:250px;}
.chart-box.full{grid-column:1/-1;}
.chart-box.full canvas{max-height:220px;}
@media(max-width:880px){.charts-grid{grid-template-columns:1fr;}}

/* EVM / RISK row */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;}
.kpi-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px 16px;}
.kpi-label{font-size:.6rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.kpi-val{font-family:var(--fh);font-size:1.5rem;font-weight:700;}
.kpi-sub{font-size:.65rem;color:var(--muted);margin-top:3px;}

/* TRANSPARENCY TABLE */
.trans-sec{margin-top:24px;}
.trans-sec h3{font-family:var(--fh);font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.mtable{width:100%;border-collapse:collapse;font-size:.72rem;}
.mtable th{text-align:left;color:var(--muted);padding:5px 10px;border-bottom:1px solid var(--border);font-weight:400;letter-spacing:1px;text-transform:uppercase;font-size:.6rem;}
.mtable td{padding:7px 10px;border-bottom:1px solid rgba(31,45,69,.4);}
.mtable tr:last-child td{border-bottom:none;}
.pill{display:inline-flex;align-items:center;gap:5px;width:100%;}
.pill-track{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.pill-fill{height:100%;border-radius:3px;}
.pill-pct{width:36px;text-align:right;font-size:.65rem;color:var(--accent);}
.fchip{display:inline-block;background:rgba(0,212,180,.06);border:1px solid rgba(0,212,180,.18);border-radius:4px;padding:1px 6px;font-size:.62rem;color:var(--accent);}
.prox-note{background:rgba(0,212,180,.04);border:1px solid rgba(0,212,180,.12);border-radius:7px;padding:12px 14px;font-size:.7rem;color:var(--muted);margin-top:14px;line-height:1.6;}
.prox-note strong{color:var(--accent);}

/* SETTINGS MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:28px;width:min(700px,95vw);max-height:85vh;overflow-y:auto;}
.modal h2{font-family:var(--fh);font-size:1rem;font-weight:700;color:#fff;margin-bottom:6px;}
.modal-sub{font-size:.7rem;color:var(--muted);margin-bottom:20px;line-height:1.5;}
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.setting-row{display:flex;flex-direction:column;gap:5px;}
.setting-label{font-size:.65rem;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;}
.setting-desc{font-size:.62rem;color:var(--border);color:#334155;}
.setting-input{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--fm);font-size:.75rem;padding:7px 10px;border-radius:6px;outline:none;transition:border-color .2s;}
.setting-input:focus{border-color:var(--accent);}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:200;font-family:var(--fh);font-size:1.1rem;color:var(--accent);}
.spin{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin-right:14px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* TOOLTIP */
.has-tooltip{position:relative;cursor:help;}
.has-tooltip .tooltip{visibility:hidden;opacity:0;position:absolute;z-index:999;background:#0f1a2e;border:1px solid var(--accent);border-radius:8px;padding:12px 14px;width:300px;font-size:.68rem;line-height:1.6;color:var(--text);box-shadow:0 8px 32px rgba(0,0,0,.6);transition:opacity .15s ease;pointer-events:none;bottom:calc(100%% + 8px);left:50%%;transform:translateX(-50%%);}
.has-tooltip .tooltip::after{content:'';position:absolute;top:100%%;left:50%%;transform:translateX(-50%%);border:6px solid transparent;border-top-color:#0f1a2e;}
.has-tooltip:hover .tooltip{visibility:visible;opacity:1;}
.tooltip-row{display:flex;justify-content:space-between;gap:12px;margin-bottom:3px;}
.tooltip-row span:first-child{color:var(--muted);}
.tooltip-row span:last-child{color:var(--accent);font-weight:600;}
.tooltip-divider{border:none;border-top:1px solid var(--border);margin:6px 0;}
.tooltip-formula{color:var(--muted);font-style:italic;font-size:.63rem;}
</style>
</head>
<body>
<div id="loading"><div class="spin"></div>Loading Dashboard‚Ä¶</div>

<header>
  <div class="logo"></div>
  <div>
    <h1>Project <span>Health</span> Dashboard</h1>
    <div class="header-sub">EVM ¬∑ CoV Confidence ¬∑ Time-Proximity Weighted ¬∑ Trend-Adjusted</div>
  </div>
  <div class="header-right">
    <span id="hdr-meta" style="font-size:.7rem;color:var(--muted)"></span>
    <button class="btn" onclick="openSettings()">‚öô Thresholds</button>
    <button class="btn btn-accent" onclick="exportPNG()">‚Üì Export PNG</button>
    <button class="btn btn-accent" onclick="exportPDF()">‚Üì Export PDF</button>
  </div>
</header>

<main id="main-content">
  <div class="sec-title">Portfolio Overview ‚Äî Latest Week</div>
  <div class="cards-grid" id="cards-grid"></div>

  <div class="detail-panel" id="detail-panel">
    <div class="detail-header">
      <div>
        <div class="detail-title" id="d-title"></div>
        <div style="font-size:.65rem;color:var(--muted);margin-top:3px" id="d-id"></div>
        <div class="date-row" id="d-dates"></div>
      </div>
      <div class="detail-scores">
        <div>
          <div class="score-label">Health</div>
          <div class="detail-score-num" id="d-health" style="color:var(--accent)"></div>
        </div>
        <div>
          <div class="score-label">Confidence</div>
          <div class="detail-score-num" id="d-conf" style="color:var(--accent2)"></div>
        </div>
      </div>
      <div class="detail-actions">
        <button class="btn" id="family-toggle-btn" onclick="toggleFamilyGroup()">‚äû Group by Family</button>
        <button class="btn btn-accent" onclick="exportDetailPNG()">‚Üì PNG</button>
      </div>
    </div>

    <!-- Narrative -->
    <div class="narrative-box" id="d-narrative"></div>

    <!-- KPI Row -->
    <div class="kpi-row" id="kpi-row"></div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-box">
        <h3>Health &amp; Confidence Trend</h3>
        <canvas id="trendChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Score Composition ‚Äî Latest Week</h3>
        <canvas id="compChart"></canvas>
      </div>
      <div class="chart-box full">
        <h3>Health Score Composition Over Time (Stacked by Metric)</h3>
        <canvas id="stackedChart"></canvas>
      </div>
    </div>

    <!-- Transparency: Health Score -->
    <div class="trans-sec">
      <h3>üìê Health Score Derivation ‚Äî Metric Breakdown</h3>
      <table class="mtable">
        <thead><tr>
          <th>Metric (sorted by drag ‚Üì)</th><th>Raw Value</th><th>Normalization Formula</th>
          <th>Norm Score</th><th>Weight</th><th>Actual / Max (pts)</th><th>Gap (pts lost)</th>
        </tr></thead>
        <tbody id="metrics-body"></tbody>
      </table>
      <div class="prox-note" id="prox-note"></div>
    </div>

    <!-- Transparency: Confidence Score -->
    <div class="trans-sec" style="margin-top:20px">
      <h3 id="conf-heading">üîÆ Confidence Score Derivation (Directional Delta-CoV)</h3>
      <table class="mtable">
        <thead><tr><th>Signal</th><th>Value</th><th>Method / Formula</th><th>Penalty Applied</th></tr></thead>
        <tbody id="conf-body"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <h2>‚öô Threshold Configuration</h2>
    <div class="modal-sub">
      Adjust normalization thresholds to match your project type and risk tolerance.
      Changes re-score all projects instantly. These parameters define when a metric hits 0.0 (worst).
    </div>
    <div class="settings-grid" id="settings-grid"></div>
    <div class="modal-footer">
      <button class="btn" onclick="resetThresholds()">Reset to Defaults</button>
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-accent" onclick="applyThresholds()">Apply &amp; Rescore</button>
    </div>
  </div>
</div>

<script>
const COLORS=['#00d4b4','#38bdf8','#818cf8','#c084fc','#f472b6','#fb923c','#facc15','#a3e635','#34d399','#67e8f9','#f43f5e','#84cc16','#06b6d4'];
const FORMULAS={
  "Schedule Variance":  "clamp((actual% ‚àí planned% + lag_max) / lag_max, 0,1)",
  "Forecast Slip":      "clamp(1 ‚àí slip_days / slip_max, 0,1)",
  "Backlog Growth":     "clamp(1 ‚àí max(0, added‚àíclosed) / net_backlog_max, 0,1)",
  "Req. Churn":         "clamp(1 ‚àí changes_4w / req_churn_max, 0,1)",
  "Defect Escape Rate": "clamp(1 ‚àí escape_rate / escape_max, 0,1)",
  "Critical Defects":   "clamp(1 ‚àí (critical/team_size) / crit_ratio, 0,1)",
  "Team Churn":         "clamp(1 ‚àí churn / team_size, 0,1)",
  "Blocked Days":       "clamp(1 ‚àí blocked_2w / blocked_max, 0,1)",
  "Unplanned Work":     "clamp(1 ‚àí unplanned / unplanned_max, 0,1)",
  "Dependencies":       "clamp(1 ‚àí dep_count / dep_max, 0,1)",
  "CPI (Cost)":         "clamp((CPI ‚àí cpi_floor) / (1 ‚àí cpi_floor), 0,1)",
  "SPI (Schedule)":     "clamp((SPI ‚àí spi_floor) / (1 ‚àí spi_floor), 0,1)",
  "Milestone Rate":     "clamp((hit/planned ‚àí ms_floor) / (1 ‚àí ms_floor), 0,1)",
  // Kanban metrics
  "Throughput Rate":    "clamp((tp/tp_avg ‚àí floor) / (1 ‚àí floor), 0,1)",
  "Cycle Time":         "clamp(1 ‚àí avg_cycle_time / cycle_time_max, 0,1)",
  "WIP Adherence":      "clamp(1 ‚àí max(0, wip/wip_limit ‚àí 1) / wip_overage_max, 0,1)",
  "Aging WIP":          "clamp(1 ‚àí aging_items / aging_wip_max, 0,1)",
};

const THRESHOLD_META={
  sched_lag_max:    {label:"Schedule Lag Max",        desc:"% behind plan = score 0.0",             unit:"%‚Üídecimal"},
  slip_days_max:    {label:"Forecast Slip Max (days)", desc:"Days of slip = score 0.0",              unit:"days"},
  net_backlog_max:  {label:"Net Backlog Max",          desc:"Net new items/4w = score 0.0",          unit:"items"},
  req_churn_max:    {label:"Req. Churn Max",           desc:"Req changes/4w = score 0.0",            unit:"changes"},
  defect_escape_max:{label:"Defect Escape Max",        desc:"Escape rate ceiling",                   unit:"rate 0‚Äì1"},
  crit_defect_ratio:{label:"Crit Defect Ratio",        desc:"Critical defects/team ceiling",         unit:"ratio"},
  blocked_days_max: {label:"Blocked Days Max",         desc:"Blocked days/2w = score 0.0",           unit:"days"},
  unplanned_max:    {label:"Unplanned Work Max",       desc:"Unplanned ratio ceiling",               unit:"ratio 0‚Äì1"},
  dep_count_max:    {label:"Dependency Count Max",     desc:"Dependency count = score 0.0",          unit:"count"},
  cpi_floor:        {label:"CPI Floor",                desc:"CPI below this = score 0.0",            unit:"index"},
  spi_floor:        {label:"SPI Floor",                desc:"SPI below this = score 0.0",            unit:"index"},
  milestone_floor:  {label:"Milestone Hit Rate Floor", desc:"Hit rate below this = score 0.0",       unit:"ratio 0‚Äì1"},
  // Kanban thresholds
  cycle_time_max:   {label:"Cycle Time Max (days)",   desc:"Avg cycle time = score 0.0 [Kanban]",   unit:"days"},
  throughput_floor: {label:"Throughput Floor",         desc:"Below X% of rolling avg = score 0.0 [Kanban]", unit:"ratio 0‚Äì1"},
  wip_overage_max:  {label:"WIP Overage Max",          desc:"% over WIP limit = score 0.0 [Kanban]", unit:"ratio 0‚Äì1"},
  aging_wip_max:    {label:"Aging WIP Max",            desc:"Aging items count = score 0.0 [Kanban]",unit:"count"},
};

const FAMILY_DEFS=[
  {name:"Schedule Performance", metrics:["Schedule Variance","Forecast Slip"],      color:"#00d4b4",colorAlt:"#009b84"},
  {name:"Scope Stability",      metrics:["Backlog Growth","Req. Churn"],             color:"#38bdf8",colorAlt:"#1a8fb5"},
  {name:"Quality",              metrics:["Defect Escape Rate","Critical Defects"],   color:"#c084fc",colorAlt:"#8b5cf6"},
  {name:"Resource Stability",   metrics:["Team Churn","Blocked Days"],              color:"#fb923c",colorAlt:"#c2622a"},
  {name:"Execution",            metrics:["Unplanned Work","Dependencies"],          color:"#facc15",colorAlt:"#c9a811"},
  {name:"EVM / Cost Performance",metrics:["CPI (Cost)","SPI (Schedule)"],          color:"#f472b6",colorAlt:"#d1548e"},
  {name:"Milestone Performance",metrics:["Milestone Rate"],                         color:"#a3e635",colorAlt:"#7db529"},
];

const KANBAN_FAMILY_DEFS=[
  {name:"Flow Performance",      metrics:["Throughput Rate","Cycle Time"],           color:"#00d4b4",colorAlt:"#009b84"},
  {name:"WIP Health",            metrics:["WIP Adherence","Aging WIP"],             color:"#38bdf8",colorAlt:"#1a8fb5"},
  {name:"Scope Stability",       metrics:["Backlog Growth","Req. Churn"],            color:"#818cf8",colorAlt:"#5a6cd4"},
  {name:"Quality",               metrics:["Defect Escape Rate","Critical Defects"],  color:"#c084fc",colorAlt:"#8b5cf6"},
  {name:"Resource Stability",    metrics:["Team Churn","Blocked Days"],             color:"#fb923c",colorAlt:"#c2622a"},
  {name:"EVM / Cost Performance",metrics:["CPI (Cost)"],                            color:"#f472b6",colorAlt:"#d1548e"},
  {name:"Milestone Performance", metrics:["Milestone Rate"],                        color:"#a3e635",colorAlt:"#7db529"},
  {name:"Target Date",           metrics:["Forecast Slip"],                         color:"#facc15",colorAlt:"#c9a811"},
];

function getFamilyDefs(framework){
  return (framework==='kanban') ? KANBAN_FAMILY_DEFS : FAMILY_DEFS;
}

let charts={}, allData=null, currentThresholds={}, currentPid=null, groupByFamily=false, currentFramework='planned';

function scoreColor(s){
  if(s>=75) return'var(--green)';
  if(s>=50) return'var(--warn)';
  return'var(--danger)';
}
function statusClass(s){ return s>=75?'good':s>=50?'warn':'danger'; }
function statusLabel(s){ return s>=75?'HEALTHY':s>=50?'AT RISK':'CRITICAL'; }

function deltaHtml(d){
  if(d===0||d===null) return`<span class="delta-badge delta-flat">‚Üí 0.0</span>`;
  if(d>0) return`<span class="delta-badge delta-up">‚ñ≤ +${d}</span>`;
  return`<span class="delta-badge delta-down">‚ñº ${d}</span>`;
}

function buildCards(summaries){
  const grid=document.getElementById('cards-grid');
  grid.innerHTML='';
  summaries.forEach(s=>{
    const cls=statusClass(s.health_score), hc=scoreColor(s.health_score), cc=scoreColor(s.confidence_score);
    const raw=s.raw;
    const fw=(raw.delivery_framework||'planned').toLowerCase();
    const isKanban=fw==='kanban';
    const riskCls=raw.risks_high>=5?'danger':raw.risks_high>=2?'warn':'';
    const msCls=raw.milestones_planned&&(raw.milestones_hit/raw.milestones_planned)<0.7?'warn':'';
    const fwBadgeCard=isKanban?`<span style="font-size:.55rem;padding:1px 6px;border-radius:99px;font-weight:700;letter-spacing:1px;background:rgba(56,189,248,.15);color:#38bdf8;border:1px solid rgba(56,189,248,.3);margin-left:5px;">KB</span>`:''

    let chips='';
    if(isKanban){
      if(raw.throughput_last_4w!=null) chips+=`<div class="chip">TP <strong>${raw.throughput_last_4w}/4w</strong></div>`;
      if(raw.avg_cycle_time!=null) chips+=`<div class="chip">CT <strong>${raw.avg_cycle_time}d</strong></div>`;
      if(raw.wip_current!=null) chips+=`<div class="chip">WIP <strong>${raw.wip_current}/${raw.wip_limit}</strong></div>`;
      if(raw.cpi!=null) chips+=`<div class="chip">CPI <strong>${raw.cpi.toFixed(2)}</strong></div>`;
    } else {
      const cpiStr=raw.cpi!=null?`CPI <strong>${raw.cpi.toFixed(2)}</strong>`:'';
      chips+=`<div class="chip">Schedule <strong>${raw.sched_var_pct>0?'+':''}${raw.sched_var_pct}%</strong></div>`;
      chips+=`<div class="chip">Slip <strong>${raw.slip_days}d</strong></div>`;
      if(cpiStr) chips+=`<div class="chip">${cpiStr}</div>`;
      if(raw.risks_high>0) chips+=`<div class="chip ${riskCls}">${raw.risks_high} high risks</div>`;
      if(raw.milestones_planned) chips+=`<div class="chip ${msCls}">MS ${raw.milestones_hit}/${raw.milestones_planned}</div>`;
    }

    const d=document.createElement('div');
    d.className=`card ${cls}`; d.dataset.pid=s.project_id;
    d.innerHTML=`
      <div class="card-header">
        <div><div class="card-name">${s.project_name}${fwBadgeCard}</div><div class="card-id">${s.project_id}</div></div>
        <span class="badge badge-${cls}">${statusLabel(s.health_score)}</span>
      </div>
      <div class="scores-row">
        <div class="score-block">
          <div class="score-label">Health</div>
          <div class="score-val" style="color:${hc}">${s.health_score}<span class="score-sub">/100</span></div>
          <div class="mini-bar"><div class="mini-fill" style="width:${s.health_score}%;background:${hc}"></div></div>
          ${deltaHtml(s.trend_delta)}
        </div>
        <div class="score-block">
          <div class="score-label">Confidence</div>
          <div class="score-val" style="color:${cc}">${s.confidence_score}<span class="score-sub">/100</span></div>
          <div class="mini-bar"><div class="mini-fill" style="width:${s.confidence_score}%;background:${cc}"></div></div>
        </div>
      </div>
      <div class="card-chips">${chips}</div>`;
    d.addEventListener('click',()=>openDetail(s.project_id));
    grid.appendChild(d);
  });
}

function openDetail(pid){
  document.querySelectorAll('.card').forEach(c=>c.classList.toggle('active',c.dataset.pid===pid));
  currentPid=pid;
  const series=allData.series.find(s=>s.project_id===pid);
  const summ=allData.summaries.find(s=>s.project_id===pid);
  const panel=document.getElementById('detail-panel');
  panel.classList.add('open');
  panel.scrollIntoView({behavior:'smooth',block:'start'});

  currentFramework = (summ.raw.delivery_framework || 'planned').toLowerCase();
  const fwBadge = currentFramework === 'kanban'
    ? `<span style="margin-left:10px;font-size:.6rem;padding:2px 8px;border-radius:99px;font-weight:700;letter-spacing:1px;background:rgba(56,189,248,.15);color:#38bdf8;border:1px solid rgba(56,189,248,.3);">KANBAN</span>`
    : `<span style="margin-left:10px;font-size:.6rem;padding:2px 8px;border-radius:99px;font-weight:700;letter-spacing:1px;background:rgba(0,212,180,.1);color:var(--accent);border:1px solid rgba(0,212,180,.25);">PLANNED</span>`;

  document.getElementById('d-title').innerHTML = series.project_name + fwBadge;
  document.getElementById('d-id').textContent=pid;
  document.getElementById('d-health').textContent=summ.health_score+'/100';
  document.getElementById('d-conf').textContent=summ.confidence_score+'/100';
  document.getElementById('d-narrative').innerHTML=renderMarkdown(summ.narrative);

  buildDates(summ.raw);
  buildKPIs(summ.raw);
  Object.values(charts).forEach(c=>c.destroy()); charts={};
  buildTrend(series);
  buildComp(summ);
  buildStacked(series);
  buildMetrics(summ);
  buildConf(summ);
}

function renderMarkdown(text){
  return text
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>');
}

function fmtDate(d){
  if(!d) return '‚Äî';
  const parts = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(parts[1])-1]} ${parseInt(parts[2])}, ${parts[0]}`;
}

function buildDates(raw){
  if(raw.delivery_framework==='kanban' && !raw.planned_end_date){
    document.getElementById('d-dates').innerHTML=`
      <div class="date-item">
        <span class="date-label">Delivery Model</span>
        <span class="date-val" style="color:#38bdf8">Continuous Flow ‚Äî No Fixed End Date</span>
      </div>`;
    return;
  }
  const slip = raw.slip_days;
  const slipBadge = slip > 0
    ? `<span class="date-slip-badge slip-pos">+${slip}d slip</span>`
    : `<span class="date-slip-badge slip-none">on schedule</span>`;
  const fcColor = slip > 30 ? 'slipped' : slip > 0 ? 'slipped' : 'on-track';
  document.getElementById('d-dates').innerHTML = `
    <div class="date-item">
      <span class="date-label">Planned End</span>
      <span class="date-val">${fmtDate(raw.planned_end_date)}</span>
    </div>
    <div style="color:var(--border);font-size:1.2rem;margin-top:10px">‚Üí</div>
    <div class="date-item">
      <span class="date-label">Forecast End</span>
      <span class="date-val ${fcColor}">${fmtDate(raw.forecast_end_date)}${slipBadge}</span>
    </div>`;
}

function kpiTooltip(label, raw){
  if(label==='CPI'){
    const ev=raw.ev, pv=raw.pv, ac=raw.ac;
    return `<div class="tooltip">
      <strong style="color:#00d4b4">Cost Performance Index (CPI)</strong>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>Earned Value (EV)</span><span>$${(ev/1000).toFixed(1)}K</span></div>
      <div class="tooltip-row"><span>Actual Cost (AC)</span><span>$${(ac/1000).toFixed(1)}K</span></div>
      <div class="tooltip-row"><span>Planned Value (PV)</span><span>$${(pv/1000).toFixed(1)}K</span></div>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>CPI = EV √∑ AC</span><span>${raw.cpi.toFixed(3)}</span></div>
      <div class="tooltip-formula">&lt;1.0 = over budget ¬∑ &gt;1.0 = under budget<br/>EV = actual% √ó PV √∑ planned%</div>
    </div>`;
  }
  if(label==='SPI'){
    const ev=raw.ev, pv=raw.pv;
    return `<div class="tooltip">
      <strong style="color:#00d4b4">Schedule Performance Index (SPI)</strong>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>Earned Value (EV)</span><span>$${(ev/1000).toFixed(1)}K</span></div>
      <div class="tooltip-row"><span>Planned Value (PV)</span><span>$${(pv/1000).toFixed(1)}K</span></div>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>SPI = EV √∑ PV</span><span>${raw.spi.toFixed(3)}</span></div>
      <div class="tooltip-formula">&lt;1.0 = behind schedule ¬∑ &gt;1.0 = ahead<br/>EV = actual% √ó PV √∑ planned%</div>
    </div>`;
  }
  if(label==='Forecast CoV'){
    const hist=raw.slip_history||[];
    const histStr=hist.map(d=>d+'d').join(' ‚Üí ');
    const deltas=raw.cov_deltas||[];
    const deltaStr=deltas.map(d=>(d>0?'+':'')+d+'d').join(', ');
    const dirWord=raw.cov_mean_delta>1?'worsening':raw.cov_mean_delta<-1?'improving':'stable';
    const dirColor=raw.cov_mean_delta>1?'var(--danger)':raw.cov_mean_delta<-1?'var(--green)':'var(--warn)';
    return `<div class="tooltip">
      <strong style="color:#00d4b4">Forecast Volatility (Directional CoV)</strong>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>Slip history (4w)</span><span>${histStr}</span></div>
      <div class="tooltip-row"><span>Week-over-week deltas</span><span>${deltaStr||'‚Äî'}</span></div>
      <div class="tooltip-row"><span>Mean delta</span><span style="color:${dirColor}">${raw.cov_mean_delta>0?'+':''}${raw.cov_mean_delta} d/wk (${dirWord})</span></div>
      <div class="tooltip-row"><span>Delta std dev</span><span>${raw.cov_std_delta} d</span></div>
      <hr class="tooltip-divider"/>
      <div class="tooltip-row"><span>Delta CoV (erraticism)</span><span>${raw.cov_delta_cov}</span></div>
      <div class="tooltip-row"><span>Directional multiplier</span><span>${raw.cov_dir_mult}√ó</span></div>
      <div class="tooltip-row"><span>Base penalty</span><span>${raw.cov_base_penalty} pts</span></div>
      <div class="tooltip-row"><span>Directional floor</span><span>${raw.cov_dir_floor} pts</span></div>
      <div class="tooltip-row"><span>Final CoV penalty</span><span style="color:var(--warn)">${raw.cov_penalty} pts</span></div>
      <hr class="tooltip-divider"/>
      <div class="tooltip-formula">Computed on forecast slip <em>changes</em>, not raw values.<br/>Consistently improving ‚Üí reduced penalty ¬∑ Worsening ‚Üí amplified.<br/>Œ¥CoV 0‚Äì0.1 = stable ¬∑ 0.1‚Äì0.5 = moderate ¬∑ &gt;0.5 = erratic</div>
    </div>`;
  }
  return '';
}

function buildKPIs(raw){
  const row=document.getElementById('kpi-row');
  const kpis=[];

  if(raw.delivery_framework==='kanban'){
    // Kanban KPIs
    if(raw.throughput_last_4w!=null){
      const tpRatio=raw.throughput_avg_4w>0?raw.throughput_last_4w/raw.throughput_avg_4w:1;
      const tc=tpRatio>=1?'var(--green)':tpRatio>=0.7?'var(--warn)':'var(--danger)';
      kpis.push({label:'Throughput',val:raw.throughput_last_4w+' items',sub:`4w avg: ${raw.throughput_avg_4w}`,color:tc});
    }
    if(raw.avg_cycle_time!=null){
      const ctc=raw.avg_cycle_time<=7?'var(--green)':raw.avg_cycle_time<=14?'var(--warn)':'var(--danger)';
      kpis.push({label:'Avg Cycle Time',val:raw.avg_cycle_time+'d',sub:'Rolling 4-week avg',color:ctc});
    }
    if(raw.wip_current!=null&&raw.wip_limit!=null){
      const wipRatio=raw.wip_current/Math.max(raw.wip_limit,1);
      const wc=wipRatio<=1?'var(--green)':wipRatio<=1.2?'var(--warn)':'var(--danger)';
      kpis.push({label:'WIP',val:`${raw.wip_current}/${raw.wip_limit}`,sub:wipRatio>1?'Over limit':'Within limit',color:wc});
    }
    if(raw.aging_wip_items!=null&&raw.aging_wip_items>0){
      const agc=raw.aging_wip_items>=5?'var(--danger)':raw.aging_wip_items>=2?'var(--warn)':'var(--green)';
      kpis.push({label:'Aging WIP',val:raw.aging_wip_items,sub:'Items past age threshold',color:agc});
    }
    if(raw.cpi!=null){
      const cc=raw.cpi>=1?'var(--green)':raw.cpi>=0.85?'var(--warn)':'var(--danger)';
      kpis.push({label:'CPI',val:raw.cpi.toFixed(2),sub:'Cost Performance Index',color:cc,tip:true});
    }
    if(raw.milestones_planned){
      const rate=Math.round(raw.milestones_hit/raw.milestones_planned*100);
      const mc=rate>=80?'var(--green)':rate>=60?'var(--warn)':'var(--danger)';
      kpis.push({label:'Milestone Rate',val:rate+'%',sub:`${raw.milestones_hit}/${raw.milestones_planned} achieved`,color:mc});
    }
    const tpCov=raw.tp_cov_delta_cov||0;
    kpis.push({label:'Throughput CoV',val:tpCov.toFixed(3),sub:'Throughput volatility',color:tpCov>0.3?'var(--danger)':tpCov>0.1?'var(--warn)':'var(--green)'});
  } else {
    // Planned KPIs
    if(raw.cpi!=null){
      const cc=raw.cpi>=1?'var(--green)':raw.cpi>=0.85?'var(--warn)':'var(--danger)';
      kpis.push({label:'CPI',val:raw.cpi.toFixed(2),sub:'Cost Performance Index',color:cc,tip:true});
      const sc=raw.spi>=1?'var(--green)':raw.spi>=0.85?'var(--warn)':'var(--danger)';
      kpis.push({label:'SPI',val:raw.spi.toFixed(2),sub:'Schedule Performance Index',color:sc,tip:true});
      const cost_var=raw.actual_cost-raw.planned_cost;
      const cv_c=cost_var>0?'var(--danger)':'var(--green)';
      kpis.push({label:'Cost Variance',val:`$${Math.abs(cost_var/1000).toFixed(0)}K`,sub:cost_var>0?'Over budget':'Under budget',color:cv_c});
    }
    if(raw.milestones_planned){
      const rate=Math.round(raw.milestones_hit/raw.milestones_planned*100);
      const mc=rate>=80?'var(--green)':rate>=60?'var(--warn)':'var(--danger)';
      kpis.push({label:'Milestone Rate',val:rate+'%',sub:`${raw.milestones_hit}/${raw.milestones_planned} achieved`,color:mc});
    }
    if(raw.risks_open>0){
      const rc=raw.risks_high>=5?'var(--danger)':raw.risks_high>=2?'var(--warn)':'var(--green)';
      kpis.push({label:'Open Risks',val:raw.risks_open,sub:`${raw.risks_high} high severity`,color:rc});
    }
    kpis.push({label:'Forecast Slip',val:raw.slip_days+'d',sub:'Days beyond planned end',color:raw.slip_days>30?'var(--danger)':raw.slip_days>0?'var(--warn)':'var(--green)'});
    kpis.push({label:'Forecast CoV',val:raw.cov.toFixed(3),sub:'Forecast volatility',color:raw.cov>0.3?'var(--danger)':raw.cov>0.1?'var(--warn)':'var(--green)',tip:true});
  }

  row.innerHTML=kpis.map(k=>`
    <div class="kpi-card ${k.tip?'has-tooltip':''}">
      ${k.tip?kpiTooltip(k.label,raw):''}
      <div class="kpi-label">${k.label}${k.tip?' <span style="color:var(--muted);font-size:.6rem">‚ìò</span>':''}</div>
      <div class="kpi-val" style="color:${k.color}">${k.val}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');
}

function buildTrend(series){
  const ctx=document.getElementById('trendChart').getContext('2d');
  charts.trend=new Chart(ctx,{type:'line',data:{labels:series.weeks,datasets:[
    {label:'Health',data:series.health,borderColor:'#00d4b4',backgroundColor:'rgba(0,212,180,.1)',borderWidth:2.5,tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#00d4b4'},
    {label:'Confidence',data:series.confidence,borderColor:'#f97316',backgroundColor:'rgba(249,115,22,.08)',borderWidth:2.5,tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#f97316'}
  ]},options:{responsive:true,maintainAspectRatio:true,
    scales:{y:{min:0,max:100,grid:{color:'#1f2d45'},ticks:{color:'#64748b',font:{family:'DM Mono'}}},
            x:{grid:{color:'#1f2d45'},ticks:{color:'#64748b',font:{family:'DM Mono',size:10}}}},
    plugins:{legend:{labels:{color:'#94a3b8',font:{family:'DM Mono'}}}}}});
}

function buildComp(summ){
  const ctx=document.getElementById('compChart').getContext('2d');
  const keys=Object.keys(summ.contributions);

  if(!groupByFamily){
    const vals=keys.map(k=>summ.contributions[k]);
    charts.comp=new Chart(ctx,{type:'doughnut',data:{labels:keys,datasets:[{data:vals,backgroundColor:COLORS,borderWidth:2,borderColor:'#111827'}]},
      options:{responsive:true,maintainAspectRatio:true,cutout:'58%',
        plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{family:'DM Mono',size:10},boxWidth:10,padding:7}},
                 tooltip:{callbacks:{label:c=>` ${c.label}: ${c.parsed.toFixed(1)} pts`}}}}});
    return;
  }

  // Grouped: 2-ring doughnut ‚Äî inner ring = families, outer ring = metrics ordered by family
  const activeFams=getFamilyDefs(currentFramework).filter(f=>f.metrics.some(m=>keys.includes(m)));
  const outerLabels=[],outerVals=[],outerColors=[];
  activeFams.forEach(fam=>{
    fam.metrics.filter(m=>keys.includes(m)).forEach((m,mi)=>{
      outerLabels.push(m);
      outerVals.push(summ.contributions[m]);
      outerColors.push(mi===0?fam.color:fam.colorAlt);
    });
  });
  const innerLabels=activeFams.map(f=>f.name);
  const innerVals=activeFams.map(f=>f.metrics.filter(m=>keys.includes(m)).reduce((s,m)=>s+summ.contributions[m],0));
  const innerColors=activeFams.map(f=>f.color);

  charts.comp=new Chart(ctx,{
    type:'doughnut',
    data:{labels:outerLabels,datasets:[
      {label:'Family',data:innerVals,backgroundColor:innerColors,borderWidth:2,borderColor:'#111827'},
      {label:'Metric',data:outerVals,backgroundColor:outerColors,borderWidth:1,borderColor:'#111827'}
    ]},
    options:{responsive:true,maintainAspectRatio:true,cutout:'40%',
      plugins:{
        legend:{position:'right',labels:{color:'#94a3b8',font:{family:'DM Mono',size:10},boxWidth:10,padding:6,
          generateLabels:function(){
            return activeFams.map((f,i)=>({
              text:f.name+' ‚Äî '+innerVals[i].toFixed(1)+'pts',
              fillStyle:f.color,strokeStyle:'#111827',lineWidth:1,hidden:false,
              fontColor:'#94a3b8',datasetIndex:0,index:i
            }));
          }
        }},
        tooltip:{callbacks:{
          title:function(items){
            const item=items[0];
            if(item.datasetIndex===0) return innerLabels[item.dataIndex]||'';
            return outerLabels[item.dataIndex]||'';
          },
          label:function(c){return' '+c.parsed.toFixed(1)+' pts';}
        }}
      }
    }
  });
}

function buildStacked(series){
  const keys=Object.keys(series.contributions_by_week[0]);
  const datasets=keys.map((k,i)=>({label:k,data:series.contributions_by_week.map(w=>w[k]),backgroundColor:COLORS[i],borderWidth:0}));
  const ctx=document.getElementById('stackedChart').getContext('2d');
  charts.stacked=new Chart(ctx,{type:'bar',data:{labels:series.weeks,datasets},
    options:{responsive:true,maintainAspectRatio:true,
      scales:{x:{stacked:true,grid:{color:'#1f2d45'},ticks:{color:'#64748b',font:{family:'DM Mono',size:10}}},
              y:{stacked:true,min:0,max:100,grid:{color:'#1f2d45'},ticks:{color:'#64748b',font:{family:'DM Mono'}}}},
      plugins:{legend:{labels:{color:'#94a3b8',font:{family:'DM Mono',size:10},boxWidth:10,padding:5}},
               tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${c.parsed.y.toFixed(1)} pts`}}}}});
}

function buildMetrics(summ){
  const body=document.getElementById('metrics-body');
  body.innerHTML='';
  const raw=summ.raw;
  const maxC=summ.max_contributions;
  const rawMap={
    "Schedule Variance": `Actual ${raw.pct_complete}% vs Planned ${raw.planned_pct}% (var ${raw.sched_var_pct>0?'+':''}${raw.sched_var_pct}%)`,
    "Forecast Slip":     `${raw.slip_days} days beyond planned end`,
    "Backlog Growth":    `Net added vs closed per 4w`,
    "Req. Churn":        `${raw.req_churn} req changes / 4 weeks`,
    "Defect Escape Rate":`${raw.defect_escape}% escape rate`,
    "Critical Defects":  `${raw.critical_defects} critical defects open`,
    "Team Churn":        `${raw.team_churn} members left / 4 weeks`,
    "Blocked Days":      `${raw.blocked_days} blocked days (2 weeks)`,
    "Unplanned Work":    `${raw.unplanned_pct}% of work unplanned`,
    "Dependencies":      `${raw.dependencies} active deps`,
    "CPI (Cost)":        raw.cpi!=null?`EV=$${(raw.ev/1000).toFixed(1)}K, AC=$${(raw.ac/1000).toFixed(1)}K ‚Üí CPI=${raw.cpi.toFixed(3)}`:'N/A',
    "SPI (Schedule)":    raw.spi!=null?`EV=$${(raw.ev/1000).toFixed(1)}K, PV=$${(raw.pv/1000).toFixed(1)}K ‚Üí SPI=${raw.spi.toFixed(3)}`:'N/A',
    "Milestone Rate":    raw.milestones_planned?`${raw.milestones_hit}/${raw.milestones_planned} milestones hit`:'N/A',
    // Kanban
    "Throughput Rate":   raw.throughput_last_4w!=null?`${raw.throughput_last_4w} items/4w (avg ${raw.throughput_avg_4w})`:'N/A',
    "Cycle Time":        raw.avg_cycle_time!=null?`${raw.avg_cycle_time} day avg cycle time`:'N/A',
    "WIP Adherence":     raw.wip_current!=null?`WIP ${raw.wip_current} / limit ${raw.wip_limit}`:'N/A',
    "Aging WIP":         raw.aging_wip_items!=null?`${raw.aging_wip_items} items past age threshold`:'N/A',
  };

  const gaps={};
  Object.keys(summ.contributions).forEach(k=>{gaps[k]=(maxC[k]||0)-summ.contributions[k];});

  function metricRow(key,color){
    const origIdx=Object.keys(summ.contributions).indexOf(key);
    const col=color||COLORS[origIdx];
    const c=summ.contributions[key], mx=maxC[key]||0, gap=gaps[key];
    const normPct=mx>0?Math.round((c/mx)*100):100;
    const gapPct=mx>0?Math.round((gap/mx)*100):0;
    const gapColor=gapPct>40?'var(--danger)':gapPct>15?'var(--warn)':'var(--green)';
    const indent=color?'padding-left:22px':'';
    const prefix=color?`<span style="color:var(--muted);margin-right:5px">‚îî</span>`:'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="color:${col};font-weight:500;${indent}">${prefix}${key}</td>
      <td style="color:var(--muted);font-size:.68rem">${rawMap[key]||'‚Äî'}</td>
      <td><span class="fchip">${FORMULAS[key]||'‚Äî'}</span></td>
      <td><div class="pill"><div class="pill-track"><div class="pill-fill" style="width:${normPct}%;background:${col}"></div></div><div class="pill-pct">${normPct}%</div></div></td>
      <td style="color:var(--muted);font-size:.65rem">prox-adj (${raw.proximity_pct}%)</td>
      <td style="color:${col};font-weight:600">${c.toFixed(1)}<span style="color:var(--muted)">/${mx.toFixed(1)}</span></td>
      <td style="color:${gapColor};font-weight:600">${gap>0.05?'‚àí'+gap.toFixed(1)+' pts':'‚úì full'}</td>`;
    return tr;
  }

  if(!groupByFamily){
    // Default: all metrics sorted by gap descending
    Object.keys(summ.contributions).sort((a,b)=>gaps[b]-gaps[a]).forEach(key=>{
      body.appendChild(metricRow(key,null));
    });
  } else {
    // Grouped by family ‚Äî families sorted by total gap desc, metrics within family by gap desc
    const activeKeys=Object.keys(summ.contributions);
    const activeFams=getFamilyDefs(currentFramework).filter(f=>f.metrics.some(m=>activeKeys.includes(m)));
    const famGaps={};
    activeFams.forEach(f=>{famGaps[f.name]=f.metrics.filter(m=>activeKeys.includes(m)).reduce((s,m)=>s+(gaps[m]||0),0);});
    [...activeFams].sort((a,b)=>famGaps[b.name]-famGaps[a.name]).forEach(fam=>{
      const famMetrics=fam.metrics.filter(m=>activeKeys.includes(m));
      const famContrib=famMetrics.reduce((s,m)=>s+(summ.contributions[m]||0),0);
      const famMax=famMetrics.reduce((s,m)=>s+(maxC[m]||0),0);
      const famGap=famGaps[fam.name];
      // Family header row
      const hdr=document.createElement('tr');
      hdr.innerHTML=`<td colspan="7" style="background:rgba(0,0,0,.25);color:${fam.color};font-family:var(--fh);font-weight:700;font-size:.72rem;letter-spacing:1px;padding:8px 10px 6px;border-top:2px solid ${fam.color}44;">${fam.name}<span style="color:var(--muted);font-weight:400;margin-left:10px;font-family:var(--fm);font-size:.65rem">${famContrib.toFixed(1)} / ${famMax.toFixed(1)} pts${famGap>0.05?' ¬∑ ‚àí'+famGap.toFixed(1)+' gap':' ¬∑ ‚úì full'}</span></td>`;
      body.appendChild(hdr);
      // Metrics within family sorted by gap desc
      famMetrics.sort((a,b)=>gaps[b]-gaps[a]).forEach(key=>{
        body.appendChild(metricRow(key,fam.color));
      });
    });
  }

  if(currentFramework==='kanban'){
    document.getElementById('prox-note').innerHTML=`
      <strong>Kanban Fixed Weights:</strong> This is a Kanban flow-based project ‚Äî no lifecycle proximity adjustment is applied.
      Weights are fixed and normalised to sum to 1.0 based on which optional metric groups (EVM, Milestone, Forecast Slip) are present.
      Flow metrics (Throughput Rate, Cycle Time, WIP Adherence, Aging WIP) drive the Flow Performance and WIP Health families.
      <br/><br/><strong>Table is sorted by gap (points lost)</strong> ‚Äî ${groupByFamily?'families':'metrics'} at the top are the biggest drag on health.`;
  } else {
    document.getElementById('prox-note').innerHTML=`
      <strong>Time-Proximity Adjustment:</strong> This project is <strong>${raw.proximity_pct}%</strong> through
      its lifecycle. Schedule, Quality, and EVM metrics receive increasing weight as the project nears completion ‚Äî
      late-stage slippage is harder to recover and defects cost more to fix. Weights are renormalized to sum to 1.0
      after adjustment, keeping the health score on a true 0‚Äì100 scale.
      <br/><br/><strong>Table is sorted by gap (points lost)</strong> ‚Äî ${groupByFamily?'families':'metrics'} at the top are the biggest drag on health.`;
  }
}

function buildConf(summ){
  const body=document.getElementById('conf-body');
  body.innerHTML='';
  const raw=summ.raw;
  const confHeading=document.getElementById('conf-heading');
  if(confHeading){
    confHeading.textContent = currentFramework==='kanban'
      ? 'üîÆ Confidence Score Derivation (Throughput CoV ‚Äî Kanban)'
      : 'üîÆ Confidence Score Derivation (Directional Delta-CoV)';
  }

  let allRows=[];

  if(currentFramework==='kanban'){
    // ‚îÄ‚îÄ Kanban: throughput CoV breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const tpDeltas=(raw.tp_cov_deltas||[]).map(d=>(d>0?'+':'')+d+' items').join(', ')||'‚Äî';
    const tpMean=raw.tp_cov_mean_delta||0;
    const tpDirWord=tpMean>1?'improving (reduced penalty)':tpMean<-1?'declining (amplified)':'stable (neutral)';
    const tpDirColor=tpMean>1?'var(--green)':tpMean<-1?'var(--danger)':'var(--warn)';
    const tpHistory=(raw.slip_history&&raw.slip_history.length>0)?raw.slip_history.map(d=>d+'d').join(' ‚Üí '):'‚Äî';
    const tpWindow=raw.throughput_last_4w!=null?`rolling window: ${raw.throughput_avg_4w} avg`:'‚Äî';

    const covRows=[
      ['‚Ü≥ Throughput history (4w)',  tpWindow,                                                                  'throughput_history[-4:]',                         ''],
      ['‚Ü≥ Week-over-week deltas',    tpDeltas,                                                                  'diff(throughput_history)',                         ''],
      ['‚Ü≥ Mean delta',               `<span style="color:${tpDirColor}">${tpMean>0?'+':''}${tpMean} items/wk (${tpDirWord})</span>`, 'mean(deltas)',  ''],
      ['‚Ü≥ Delta CoV (erraticism)',   `${raw.tp_cov_delta_cov||0}`,                                             'œÉ(deltas) / max(|Œº(deltas)|, 1)',                 ''],
      ['‚Ü≥ Base erraticism penalty',  `${raw.tp_cov_base_penalty||0} pts`,                                      'clamp(Œ¥CoV / 0.5) √ó 30',                          ''],
      ['‚Ü≥ Directional multiplier',   `${raw.tp_cov_dir_mult||1}√ó`,                                             '1 ‚àí 0.4 √ó tanh(mean_delta / 3)  [inverted]',      ''],
      ['‚Ü≥ Directional floor',        `${raw.tp_cov_dir_floor||0} pts`,                                         'clamp(‚àídir_factor, 0,1) √ó 8',                     ''],
      ['Throughput Volatility (total)','‚Äî',                                                                     'max(base√ómult, dir_floor), clamped [0,40]',       `‚àí${raw.tp_cov_penalty||0} pts`],
    ];
    const otherRows=[
      ['Requirements Churn',         `${raw.req_churn} changes/4w`,                                            'changes √ó 1.0',                                   `‚àí${raw.churn_penalty} pts`],
      ['Backlog Net Growth',          'added ‚àí closed / 4w',                                                    'net_backlog √ó 0.5',                               `‚àí${raw.backlog_penalty} pts`],
    ];
    if(raw.slip_days>0){
      otherRows.push(['Forecast Slip (target date)', `${raw.slip_days} days`, 'slip_days √ó 0.15  [lighter than planned]', `‚àí${raw.slip_penalty} pts`]);
    }
    otherRows.push(['Final Confidence', '‚Äî', '100 ‚àí Œ£ penalties, clamped [0,100]', `<strong style="color:var(--accent2)">${summ.confidence_score}/100</strong>`]);
    allRows=[...covRows,...otherRows];

  } else {
    // ‚îÄ‚îÄ Planned: forecast slip CoV breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const deltas=(raw.cov_deltas||[]).map(d=>(d>0?'+':'')+d+'d').join(', ')||'‚Äî';
    const dirWord=raw.cov_mean_delta>1?'worsening (amplified)':raw.cov_mean_delta<-1?'improving (reduced)':'stable (neutral)';
    const dirColor=raw.cov_mean_delta>1?'var(--danger)':raw.cov_mean_delta<-1?'var(--green)':'var(--warn)';

    const covRows=[
      ['‚Ü≥ Slip history (4w)',       (raw.slip_history||[]).map(d=>d+'d').join(' ‚Üí '),  'raw forecast slip values',                      ''],
      ['‚Ü≥ Week-over-week deltas',   deltas,                                             'diff(slip_history)',                             ''],
      ['‚Ü≥ Mean delta',              `<span style="color:${dirColor}">${raw.cov_mean_delta>0?'+':''}${raw.cov_mean_delta} d/wk (${dirWord})</span>`, 'mean(deltas)', ''],
      ['‚Ü≥ Delta CoV (erraticism)',  `${raw.cov_delta_cov}`,                             'œÉ(deltas) / max(|Œº(deltas)|, 10)',               ''],
      ['‚Ü≥ Base erraticism penalty', `${raw.cov_base_penalty} pts`,                      'clamp(Œ¥CoV / 0.5) √ó 30',                        ''],
      ['‚Ü≥ Directional multiplier',  `${raw.cov_dir_mult}√ó`,                             '1 + 0.4 √ó tanh(mean_delta / 7)',                ''],
      ['‚Ü≥ Directional floor',       `${raw.cov_dir_floor} pts`,                         'clamp(dir_factor, 0,1) √ó 8',                    ''],
      ['Forecast Volatility (total)','‚Äî',                                               'max(base√ómult, dir_floor), clamped [0,40]',      `‚àí${raw.cov_penalty} pts`],
    ];
    const otherRows=[
      ['Requirements Churn',        `${raw.req_churn} changes/4w`,                      'changes √ó 1.0',                                 `‚àí${raw.churn_penalty} pts`],
      ['Backlog Net Growth',        'added ‚àí closed / 4w',                              'net_backlog √ó 0.5',                             `‚àí${raw.backlog_penalty} pts`],
      ['Forecast Slip',             `${raw.slip_days} days`,                            'slip_days √ó 0.25',                              `‚àí${raw.slip_penalty} pts`],
      ['Final Confidence',          '‚Äî',                                                '100 ‚àí Œ£ penalties, clamped [0,100]',             `<strong style="color:var(--accent2)">${summ.confidence_score}/100</strong>`],
    ];
    allRows=[...covRows,...otherRows];
  }

  allRows.forEach(([s,v,f,p])=>{
    const tr=document.createElement('tr');
    const isSubRow = s.startsWith('‚Ü≥');
    const isTotal  = s==='Final Confidence' || s==='Forecast Volatility (total)' || s==='Throughput Volatility (total)';
    const rowStyle = isSubRow ? 'opacity:.75' : isTotal ? 'font-weight:600' : '';
    tr.style.cssText = rowStyle;
    tr.innerHTML=`
      <td style="color:${isSubRow?'var(--muted)':'var(--text)'};padding-left:${isSubRow?'20px':'10px'}">${s}</td>
      <td style="color:var(--accent2);font-size:.67rem">${v}</td>
      <td><span class="fchip" style="font-size:.6rem">${f}</span></td>
      <td style="color:var(--warn)">${p}</td>`;
    body.appendChild(tr);
  });
}

// ‚îÄ‚îÄ FAMILY GROUPING TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFamilyGroup(){
  groupByFamily=!groupByFamily;
  const btn=document.getElementById('family-toggle-btn');
  if(groupByFamily){btn.classList.add('btn-accent');btn.textContent='‚äû Grouped by Family';}
  else{btn.classList.remove('btn-accent');btn.textContent='‚äû Group by Family';}
  if(currentPid){
    const summ=allData.summaries.find(s=>s.project_id===currentPid);
    currentFramework=(summ.raw.delivery_framework||'planned').toLowerCase();
    if(charts.comp){charts.comp.destroy();delete charts.comp;}
    buildComp(summ);
    buildMetrics(summ);
  }
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings(){
  const grid=document.getElementById('settings-grid');
  grid.innerHTML='';
  Object.entries(THRESHOLD_META).forEach(([key,meta])=>{
    const val=currentThresholds[key]??'';
    grid.innerHTML+=`
      <div class="setting-row">
        <div class="setting-label">${meta.label}</div>
        <div class="setting-desc">${meta.desc} (${meta.unit})</div>
        <input class="setting-input" type="number" step="any" id="th_${key}" value="${val}"/>
      </div>`;
  });
  document.getElementById('settings-modal').classList.add('open');
}
function closeSettings(){ document.getElementById('settings-modal').classList.remove('open'); }
function resetThresholds(){
  Object.entries(THRESHOLD_META).forEach(([key])=>{
    const el=document.getElementById('th_'+key);
    if(el && defaultThresholds[key]!=null) el.value=defaultThresholds[key];
  });
}
let defaultThresholds={};
function applyThresholds(){
  const params=new URLSearchParams();
  Object.keys(THRESHOLD_META).forEach(key=>{
    const el=document.getElementById('th_'+key);
    if(el&&el.value) params.set(key,el.value);
  });
  closeSettings();
  document.getElementById('loading').style.display='flex';
  fetch('/api/data?'+params.toString()).then(r=>r.json()).then(data=>{
    document.getElementById('loading').style.display='none';
    allData=data; currentThresholds=data.thresholds;
    buildCards(data.summaries);
    if(currentPid) openDetail(currentPid);
  });
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportPNG(){
  html2canvas(document.getElementById('main-content'),{backgroundColor:'#0b0f1a',scale:2}).then(canvas=>{
    const a=document.createElement('a'); a.download='project-health-dashboard.png';
    a.href=canvas.toDataURL('image/png'); a.click();
  });
}
function exportDetailPNG(){
  const panel=document.getElementById('detail-panel');
  if(!panel.classList.contains('open')) return;
  html2canvas(panel,{backgroundColor:'#111827',scale:2}).then(canvas=>{
    const a=document.createElement('a'); a.download=`project-detail-${currentPid}.png`;
    a.href=canvas.toDataURL('image/png'); a.click();
  });
}
function exportPDF(){
  html2canvas(document.getElementById('main-content'),{backgroundColor:'#0b0f1a',scale:1.5}).then(canvas=>{
    const img=canvas.toDataURL('image/png');
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Project Health Dashboard</title>
      <style>body{margin:0;}img{width:100%;}</style></head>
      <body><img src="${img}" onload="window.print()"/></body></html>`);
    w.document.close();
  });
}

// Close modal on overlay click
document.getElementById('settings-modal').addEventListener('click',e=>{
  if(e.target===e.currentTarget) closeSettings();
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
fetch('/api/data').then(r=>r.json()).then(data=>{
  allData=data;
  currentThresholds=data.thresholds;
  defaultThresholds=Object.assign({},data.thresholds);
  document.getElementById('loading').style.display='none';
  document.getElementById('hdr-meta').textContent=`${data.summaries.length} Projects`;
  buildCards(data.summaries);
  if(data.summaries.length>0) openDetail(data.summaries[0].project_id);
});
</script>
</body>
</html>
